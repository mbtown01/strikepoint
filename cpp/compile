#!/bin/bash
# set -euo pipefail

# Simple build helper:
#   ./compile <Config> [--clean] [--jobs N]
# Examples:
#   ./compile Release
#   ./compile Debug --jobs 8
#   ./compile Release --clean

usage() {
    echo "Usage: $0 <Config> [--clean] [--jobs N] [--help]"
    echo "  <Config>   Build configuration (e.g. Debug, Release)"
    echo "  --clean    Run clean in the build directory and exit"
    echo "  --jobs N   Parallel build jobs (forwarded to build tool)"
    exit 1
}

die() {
    echo "Error: $1"
    exit 2
}

LEPTON_ROOT="$(readlink -f "$0")"
LEPTON_ROOT="$(dirname "${LEPTON_ROOT}")"

BUILD_CONFIG="Debug"

while [ $# -gt 0 ]; do
    case "$1" in
        --help|-h)
            usage
            ;;
        Debug|debug)
            BUILD_CONFIG="Debug"
            shift
            ;;
        Release|release)
            BUILD_CONFIG="Release"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            usage
            ;;
    esac
done

cd "${LEPTON_ROOT}"
BUILD_DIR="./${BUILD_CONFIG}"
mkdir -p "${BUILD_DIR}"

cmake -B ${BUILD_CONFIG} -S . -DCMAKE_BUILD_TYPE=${BUILD_CONFIG} || \
    die "CMake configuration failed"
cd ${BUILD_CONFIG} || die "Failed to enter build directory"
exec make -j 4 CFG=${BUILD_CONFIG}
